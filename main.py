from ConfigParser import SafeConfigParser
from capstone import *
import pefile
import os
import os.path

#import utils

#import RF_train

def retrieve_opcodes_and_labels(directory_name, text_file):
    config = SafeConfigParser()
    config.read('./config/main.conf')

    # (error_2)
    # in the def-function, you have got to set variable of SafeConfigParser() 
    # and read with '.read()' method like below

    with open(text_file, "w") as f:
        if directory_name == config.get('main', 'malware_directory'):
            f.write('Malicious\n\n\n')

        else:
            f.write('Benign\n\n\n')

        list_of_sotware = os.listdir(directory_name)
        
        # (error_3)
        # not 'os.path.listdir', it's 'os.listdir'

        for i in list_of_sotware:
            full_path = os.path.join(directory_name, i)
            f.write(full_path)
            f.write('\n')
            pe = pefile.PE(full_path)

            ep = pe.OPTIONAL_HEADER.AddressOfEntryPoint
            ep_ava = ep + pe.OPTIONAL_HEADER.ImageBase
            data = pe.get_memory_mapped_image()

            md = Cs(CS_ARCH_X86, CS_MODE_64)

            for j in md.disasm(data, ep_ava):
                # (error_4)
                # all stuffs in opcodes are just number, not str, so
                # you should replace the type of it using str()

                #opcode = []
                #opcode.append(str(j.address))
                #opcode.append(str(j.mnemonic))
                #opcode.append(str(j.op_str))
                #opcode_list = " ".join(opcode)
                #for k in opcode_list:
                    #f.write(k)
                #f.write('\n')
                
                opcode = str(j.mnemonic) + '\t'
                f.write(opcode)


            f.write('\n\n')

def n_gram(number, list_of_opcodes):
    list_of_letter_ngram = []
    number_of_letter = len(list_of_opcodes)
    # if number is set 2, meaninig 2-gram, number_to_decrement will be set 1, for 2 - 1 = 1, 
    # then, decrement number_of_letter using number_to_decrement, which stands for
    # the limitation of this loop
    number_to_decrement = number - 1

    for k in xrange(number_of_letter - number_to_decrement):
        tmp_ngram = []
        for l in len(number):
            tmp_ngram.append(list_of_opcodes[l])
        for m in xrange(len(tmp_ngram)):
            list_of_letter_ngram.append(tmp_ngram[m])

    return list_of_letter_ngram

def main():

    config = SafeConfigParser()
    config.read('./config/main.conf')

    b = config.get('main', 'benign_txt')
    m = config.get('main', 'malicious_txt')

    #retrieve_opcodes_and_labels(config.get('main', 'benign_directory'), m)
    retrieve_opcodes_and_labels(config.get('main', 'benign_directory'), b)
    # (error_1)
    # don`t recongnise the second argument like "benign.txt"
    
    

if __name__ == '__main__':
    main()